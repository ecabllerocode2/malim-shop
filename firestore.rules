rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // FUNCIONES DE SEGURIDAD
    // ============================================
    
    // Verifica si el usuario tiene el permiso de administrador (Custom Claim)
    function isBackend() {
      return request.auth != null && request.auth.token.admin == true;
    }
    
    // Verifica si el usuario autenticado es el dueño del documento
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // ============================================
    // REGLAS POR COLECCIÓN
    // ============================================
    
    // PRODUCTOS_PUBLIC: Colección pública solo lectura (sin datos sensibles)
    match /productos_public/{productId} {
      // Permitir lectura completa a todos los usuarios
      allow read: if true;
      
      // Solo el backend puede escribir
      allow write: if isBackend();
    }
    
    // PRODUCTOS: Solo accesible por Admin (contiene datos sensibles)
    match /productos/{productId} {
      // Solo el backend/admin puede leer y escribir
      allow read, write: if isBackend();
      
      // Subcolecciones
      match /{subcollection=**} {
        allow read, write: if isBackend();
      }
    }
    
    // ÓRDENES Y PAGOS: Solo el dueño puede leer, solo el Backend (Admin) puede crear/editar
    match /ordenes/{orderId} {
      allow read: if isOwner(resource.data.userId) || isBackend();
      allow write: if isBackend();
    }
    
    match /pagos/{pagoId} {
      allow read: if isOwner(resource.data.userId) || isBackend();
      allow write: if isBackend();
    }
    
    // CLIENTES: El usuario puede leer su propio perfil, Admin tiene acceso total
    match /clientes/{clienteId} {
      allow read: if isOwner(clienteId) || isBackend();
      allow write: if isBackend();
    }
    
    // USERS_ASISTANT: Datos del usuario manejados por el backend (solo lectura desde cliente)
    match /users_asistant/{userId} {
      allow read: if isOwner(userId) || isBackend();
      allow write: if isBackend();  // Solo el backend puede escribir
    }
    
    // MARKETING_CONTACTS: Solo el backend puede escribir
    match /marketing_contacts/{userId} {
      allow read: if isOwner(userId) || isBackend();
      allow write: if isBackend();
    }
    
    // COLECCIONES PRIVADAS: Solo accesibles por el Administrador/Backend
    match /credenciales/{document=**} {
      allow read, write: if isBackend();
    }
    
    match /inventory_movements/{movementId} {
      allow read, write: if isBackend();
    }
    
    match /entregas/{entregaId} {
      allow read, write: if isBackend();
    }

    // ============================================
    // SEGURIDAD GLOBAL
    // ============================================
    
    // Denegar cualquier acceso no especificado arriba
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
